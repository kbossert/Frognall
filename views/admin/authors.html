<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <!-- disable iPhone initial scale -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Authors</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>

    <!-- Bootstrap CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

    <!-- Load Custom Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    <script src="https://use.fontawesome.com/cad0d4468f.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/css/main.css" type="text/css" media="all" />

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="~/Content/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="~/Content/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="shortcut icon" type="image/x-icon" href="~/Content/favicons/favicon.ico" >

</head>
<body>

<nav class="navbar navbar-expand-lg navbar_brand navbar-fixed-top" role="navigation">
  <div class="navigation_container">
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="/" title="Public">Public</a></li>
        <li class="nav-item"><a class="nav-link" href="/Admin/Authors.html" title="Authors">Authors</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container manage_page_container">

    <h3 class="section_title">Authors</h3>

    <div id="manage_content_area">
        <div class="row">
            <div class="col">

                <div class="manage_container" id="new_button_area">
                    <input type="text" class="form-control manage_search" id="search_term" />
                    <button type="button" class="btn btn-primary manage_button" id="find">Find Author</button>
                    <button type="button" class="btn btn-primary" id="new">New Author</button>
                </div>

            </div>
        </div>

        <div class="row">
            <div class="col grid_header" id="header_area">
                <div class="table_container">
                    <table class="table" id="table_contents">
                        <thead>
                            <tr class="table_header">
                                <th>Author</th>
                                <th>Nationality</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div  id="edit_area" style="display:none">

                <form class="form-horizontal" action="" method="post" id="manage_form">

                  <div class="row">

                    <div class="col-xs-6" style="padding-right:10px">

                      <span id="authorID" style="display:none"></span>

                      <div class="manage_container">
                          <label class="form_label">Image Alt</label>
                          <input name="image_alt" type="text" class="form-control large_field" id="image_alt" placeholder="Image Alt">
                      </div>

                      <div class="manage_container">
                          <label class="form_label">First Name</label>
                          <input name="first_name" type="text" class="form-control large_field" id="first_name" placeholder="First Name">
                      </div>

                      <div class="manage_container">
                          <label class="form_label">Last Name</label>
                          <input name="last_name" type="text" class="form-control large_field" id="last_name" placeholder="Last Name">
                      </div>

                      <div class="manage_container">
                          <label class="form_label">Nationality</label>
                          <input name="nationality" type="text" class="form-control large_field" id="nationality" placeholder="Nationality Text">
                      </div>

                      <div class="manage_container">
                          <label class="form_label">Birth</label>
                          <input name="start" type="text" class="form-control large_field" id="birth" placeholder="Birth">
                      </div>

                      <div class="manage_container">
                          <label class="form_label">Death</label>
                          <input name="end" type="text" class="form-control large_field" id="death" placeholder="Death">
                      </div>

                      <button type="button" class="btn btn-primary" id="save">Save</button>
                      <button type="button" class="btn btn-primary" id="cancel">Cancel</button>

                      <!-- <div class="manage_container">
                          <label class="form_label">Years</label>
                          <input name="years" type="text" class="form-control large_field" id="years" placeholder="Years">
                      </div>

                      <div class="manage_container">
                          <label class="form_label">Group</label>
                          <input name="group" type="text" class="form-control large_field" id="group" placeholder="Group">
                      </div> -->

                    </div>

                    <div class="col-xs-6">

                      <div class="manage_container">
                          <label class="form_label">Wiki</label>
                          <input name="wiki" type="text" class="form-control ex_large_field" id="wiki" placeholder="Wiki">
                      </div>

                      <div class="manage_container">
                          <label class="form_label">Notes</label>
                          <!-- <input name="notes" type="text" class="form-control ex_large_field" id="notes" placeholder="Notes"> -->
                          <textarea type="text" cols="60" rows="12" class="author_input" id="notes" /></textarea>
                      </div>

                      <!-- <div class="manage_container" id="image_area">
                        <label class="form_label">Author Image</label>
                          <img id="image" src="" width="200" height="200" />
                      </div>

                      <div class="manage_container">
                        <label class="form_label">&nbsp;</label>
                          <input type="file" name="UploadFile" class="upload_file_field" id="image_upload" />
                          <div id="upload_loader" class="loader" style="display:none;"><img src="/Images/loader.gif" /></div>
                      </div>

                      <div class="manage_data_container" id="image_file_area" style="display:none">
                          <label class="form_label">Image File</label>
                          <p class="manage_data" id="attachment_name"></p>
                      </div> -->

                  </div>

                  </div>

                </form>
            </div>

        </div>

    </div>

</div>

<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="modal_error">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <p></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="/scripts/tablesort.js")" type="text/javascript"></script>
<script src="/scripts/modal.js")" type="text/javascript"></script>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>

    $(document).ready(function () {

        Frognall = {};

        GetAuthors();

    });

    $("#find").click(function () {
        GetAuthors();
    });

    $("#search_term").keypress(function (e) {
      if (e.keyCode === 13)
        GetAuthors();
    });

    $('#manage_content_area').on('click', '.edit', function () {

        var authorID = $(this).attr('id');

        axios.get('http://localhost:3000/getAuthor/' + authorID)
          .then(function (response) {

            Frognall.Author = {};

            Frognall.Author.AuthorID = response.data.Author._id;
            Frognall.Author.FirstName = response.data.Author.FirstName;
            Frognall.Author.LastName = response.data.Author.LastName;
            // Frognall.Author.AuthorImage = data.Author.AuthorImage;
            Frognall.Author.ImageAlt = response.data.Author.ImageAlt;
            Frognall.Author.Nationality = response.data.Author.Nationality;
            Frognall.Author.Birth = response.data.Author.Birth;
            Frognall.Author.Death = response.data.Author.Death;
            Frognall.Author.Notes = response.data.Author.Notes;
            Frognall.Author.External = response.data.Author.External;

            DisplayAuthor(Frognall.Author);
          })
          .catch(function (error) {
              console.log(error);
          });
    });

    $('#manage_content_area').on('click', '.delete', function () {

        var authorID = $(this).attr('id');

        axios.post('http://localhost:3000/deleteAuthor', { authorID: authorID })
          .then(function (response) {
              ShowModal("Save Author", response.data.Result);
              GetAuthors();
          })
          .catch(function (error) {
              console.log(error);
          });

    });

    $("#new").click(function () {
        NewAuthor();
    });

    $("#save").click(function () {

      Frognall.Author = {};

      Frognall.Author.AuthorID = $('#authorID').text();
      Frognall.Author.AuthorImage = $('#attachment_name').text();
      Frognall.Author.ImageAlt = $('#image_alt').val();
      Frognall.Author.FirstName = $('#first_name').val();
      Frognall.Author.LastName = $('#last_name').val();
      Frognall.Author.Birth = $('#birth').val();
      Frognall.Author.Death = $('#death').val();
      Frognall.Author.Nationality = $('#nationality').val();
      Frognall.Author.Notes = $('#notes').val();
      Frognall.Author.External = $('#wiki').val();
      Frognall.Author.Group = 'A';

      SaveAuthor(Frognall.Author, 'The Author has been saved.');
    });

    $("#cancel").click(function () {
        $('#new_button_area').show();
        $('#header_area').show();
        $('#edit_area').hide();

        GetAuthors();
    });

    $('#image_upload').on('change', function (e) {

        //var validator = $('#template_form').data('bootstrapValidator');
        //validator.validate();

        //if (validator.isValid()) {

            var files = e.target.files;
            if (files.length > 0) {
                if (window.FormData !== undefined) {
                    var data = new FormData();
                    for (var x = 0; x < files.length; x++) {
                        data.append("file" + x, files[x]);
                    }

                    $.ajax({
                        type: "POST",
                        url: '/Manage/UploadAuthorImage',
                        contentType: false,
                        processData: false,
                        data: data,
                        success: function (data) {
                            if (data.Result = "OK") {
                                Frognall.Author.AuthorID = $('#AuthorID').text();
                                Frognall.Author.ActiveStatus = $('#activeStatus').text();
                                Frognall.Author.AuthorImage = $('#attachment_name').text();
                                Frognall.Author.ImageAlt = $('#image_alt').val();
                                Frognall.Author.Headline = $('#headline').val();
                                Frognall.Author.HeadlineText = $('#headline_text').val();
                                Frognall.Author.ButtonText = $('#button_text').val();

                                SaveAuthor(Frognall.Author, 'Your image has been uploaded.');

                                $('#attachment_name').text(Frognall.Author.AttachmentFile);
                            }
                            else {
                                ShowModal('File Upload', data.Result);
                            }
                        },
                        error: function (xhr, status, p3, p4) {
                            var err = "Error " + " " + status + " " + p3 + " " + p4;
                            if (xhr.responseText && xhr.responseText[0] == "{")
                                err = JSON.parse(xhr.responseText).Message;
                            ShowModal('File Upload', err);
                        }
                    });
                }
                else {
                    ShowModal('File Upload', 'This browser does not support HTML5 file uploads.');
                }
            }
        //}
    });

    function GetAuthors() {

      var searchTerm = $('#search_term').val();
      if (searchTerm) {
        axios.get('http://localhost:3000/getAuthors/' + searchTerm)
          .then(function (response) {
              DisplayAuthors(response.data.Authors);
          })
          .catch(function (error) {
              console.log(error);
          });
      }
      else {
        axios.get('http://localhost:3000/getAllAuthors/')
          .then(function (response) {
              DisplayAuthors(response.data.Authors);
          })
          .catch(function (error) {
              console.log(error);
          });
      }
    };

    function NewAuthor() {

        Frognall.Author = {};

        Frognall.Author.AuthorID = -1;
        Frognall.Author.ActiveStatus = "INACTIVE";

        Frognall.Author.AuthorImage = '';
        Frognall.Author.ImageAlt = '';
        Frognall.Author.Birth = '';
        Frognall.Author.Death = '';
        Frognall.Author.FirstName = '';
        Frognall.Author.LastName = '';
        Frognall.Author.Nationality = '';
        Frognall.Author.Notes = '';
        Frognall.Author.External = '';

        //$('#user_form').bootstrapValidator("resetForm", true);

        $('#authorID').text("-1");
        $('#activeStatus').text("INACTIVE");

        $('#image').attr('src', '');
        $('#attachment_name').text('');
        $('#image_alt').val('');
        $('#first_name').val('');
        $('#last_name').val('');
        $('#nationality').val('');
        $('#birth').val('');
        $('#death').val('');
        $('#notes').val('');
        $('#wiki').val('');

        $('#image_area').hide();
        $('#image_file_area').hide();
        $('#new_button_area').hide();
        $('#header_area').hide();
        $('#edit_area').show();
    }

    function SaveAuthor(author, message) {

      axios.post('http://localhost:3000/saveAuthor', { author: author })
        .then(function (response) {
            ShowModal("Save Author", response.data.Result);
            GetAuthors();
        })
        .catch(function (error) {
            console.log(error);
        });
    }

    function DisplayAuthor(Author) {

        //$('#manage_form').bootstrapValidator("resetForm", true);

        $('#authorID').text(Author.AuthorID);
        $('#first_name').val(Author.FirstName);
        $('#last_name').val(Author.LastName);
        $('#nationality').val(Author.Nationality);
        $('#birth').val(Author.Birth);
        $('#death').val(Author.Death);
        $('#notes').val(Author.Notes);
        $('#wiki').val(Author.External);
        $('#image_alt').val(Author.ImageAlt);

        $('#header_area').hide();

        $('#new_button_area').hide();
        $('#image_area').show();

        if (Author.AuthorImage) {
          $('#image_file_area').show();
        }

        // $('#AuthorID').text(Author.AuthorID);
        // $('#activeStatus').text(Author.ActiveStatus);

        // $('#image').attr('src', Author.AuthorImage);
        // $('#attachment_name').text(Author.AuthorImage);
        // $('#image_alt').val(Author.ImageAlt);

        $('#edit_area').show();
    }

    function DisplayAuthors(authors) {

        var markup = "";

        if (authors.length > 0) {
            for (var i = 0; i < authors.length; i++) {
                markup = markup.concat('<tr><td>' + authors[i].FirstName + ' ' + authors[i].LastName + '</td><td>' + authors[i].Nationality + '</td><td><button type="button" id=' + authors[i]._id + ' class="edit btn btn-primary btn-sm">Edit</button></td><td><button type="button" id=' + authors[i]._id + ' class="delete btn btn-primary btn-sm">Delete</button></td></tr>');
            }
        }

        $('#table_contents tbody').html(markup);

        $('#image_area').show();
        $('#image_file_area').show();
        $('#new_button_area').show();
        $('#header_area').show();
        $('#edit_area').hide();

    }

</script>
